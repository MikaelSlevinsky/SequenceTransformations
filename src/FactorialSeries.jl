export factorialseries, stirlingseries

# evaluate p[1]/(z)₁ + p[2]/(z)₂ + p[3]/(z)₃ + ⋯, i.e. a rising factorial series via downward recurrence
macro factorialseries(z, p...)
    ex = esc(p[end])
    for i = length(p)-1:-1:1
        ex = :(muladd(inv(x+$i), $ex, $(esc(p[i]))))
    end
    ex = :($ex/x)
    Expr(:block, :(x = $(esc(z))), ex)
end

# stirlingseries is a factorially resummed (convergent) version of Stirling's series for the gamma function.

stirlingseries(z::Float64,n::Val{1}) = @factorialseries(z+1,1/12)
stirlingseries(z::Float64,n::Val{2}) = @factorialseries(z+1,1/12,1/12)
stirlingseries(z::Float64,n::Val{3}) = @factorialseries(z+1,1/12,1/12,59/360)
stirlingseries(z::Float64,n::Val{4}) = @factorialseries(z+1,1/12,1/12,59/360,29/60)
stirlingseries(z::Float64,n::Val{5}) = @factorialseries(z+1,1/12,1/12,59/360,29/60,533/280)
stirlingseries(z::Float64,n::Val{6}) = @factorialseries(z+1,1/12,1/12,59/360,29/60,533/280,1577/168)
stirlingseries(z::Float64,n::Val{7}) = @factorialseries(z+1,1/12,1/12,59/360,29/60,533/280,1577/168,280361/5040)
stirlingseries(z::Float64,n::Val{8}) = @factorialseries(z+1,1/12,1/12,59/360,29/60,533/280,1577/168,280361/5040,69311/180)
stirlingseries(z::Float64,n::Val{9}) = @factorialseries(z+1,1/12,1/12,59/360,29/60,533/280,1577/168,280361/5040,69311/180,36226519/11880)
stirlingseries(z::Float64,n::Val{10}) = @factorialseries(z+1,1/12,1/12,59/360,29/60,533/280,1577/168,280361/5040,69311/180,36226519/11880,7178335/264)
stirlingseries(z::Float64,n::Val{11}) = @factorialseries(z+1,1/12,1/12,59/360,29/60,533/280,1577/168,280361/5040,69311/180,36226519/11880,7178335/264,64766889203/240240)
stirlingseries(z::Float64,n::Val{12}) = @factorialseries(z+1,1/12,1/12,59/360,29/60,533/280,1577/168,280361/5040,69311/180,36226519/11880,7178335/264,64766889203/240240,32128227179/10920)
stirlingseries(z::Float64,n::Val{13}) = @factorialseries(z+1,1/12,1/12,59/360,29/60,533/280,1577/168,280361/5040,69311/180,36226519/11880,7178335/264,64766889203/240240,32128227179/10920,459253205417/13104)
stirlingseries(z::Float64,n::Val{14}) = @factorialseries(z+1,1/12,1/12,59/360,29/60,533/280,1577/168,280361/5040,69311/180,36226519/11880,7178335/264,64766889203/240240,32128227179/10920,459253205417/13104,325788932161/720)
stirlingseries(z::Float64,n::Val{15}) = @factorialseries(z+1,1/12,1/12,59/360,29/60,533/280,1577/168,280361/5040,69311/180,36226519/11880,7178335/264,64766889203/240240,32128227179/10920,459253205417/13104,325788932161/720,2311165698322609/367200)

stirlingseries(z::AbstractVector,n::Val{N}) where N = [ stirlingseries(z[i],n) for i=1:length(z) ]

function stirlingnumbers(n::Int)
    s = zeros(BigInt,n)
    s[1] = 1
    for nn = 2:n
        for k = nn:-1:2
            s[k] = (nn-1)*s[k] + s[k-1]
        end
        s[1] = (nn-1)*s[1]
    end
    s
end

function stirlingcoefficient(n::Int)
    s = stirlingnumbers(n)
    cₙ = s[1]//2//3
    for k = 2:n
        cₙ += k*s[k]//(k+1)//(k+2)
    end
    cₙ//2n
end

# 1/12,1/12,59/360,29/60,533/280,1577/168,280361/5040,69311/180,36226519/11880,7178335/264,64766889203/240240,32128227179/10920,459253205417/13104,325788932161/720,2311165698322609/367200,287144996287039/3060,1215091897184850539/813960,402833263943353393/15960,476099430416027805187/1053360,236881416523193720213/27720,650730651653461090091101/3825360,58892403426105875913001/16560,391322630274754041620578051/5023200,292283822581742493926985629/163800,41922362896177303908488106751/982800,3212518869076718326256692951/3024,72400537401483369096899447543287/2630880,5153156706882006699283666106197/6960,686476646948153636599886190355425587/33227040,136841160970757197040629784385718445/229152,2086964833758413423189466175604216292877/116867520,130030515625408962047441059505505281107/235620,4978142183290000320492136142405979085829/282744,1459881140954415563253751607947838024953/2520,31663466129700972962247259201794272834399495731/1612119600
# 1//12,1//12,59//360,29//60,533//280,1577//168,280361//5040,69311//180,36226519//11880,7178335//264,64766889203//240240,32128227179//10920,459253205417//13104,325788932161//720,2311165698322609//367200,287144996287039//3060,1215091897184850539//813960,402833263943353393//15960,476099430416027805187//1053360,236881416523193720213//27720,650730651653461090091101//3825360,58892403426105875913001//16560,391322630274754041620578051//5023200,292283822581742493926985629//163800,41922362896177303908488106751//982800,3212518869076718326256692951//3024,72400537401483369096899447543287//2630880,5153156706882006699283666106197//6960,686476646948153636599886190355425587//33227040,136841160970757197040629784385718445//229152,2086964833758413423189466175604216292877//116867520,130030515625408962047441059505505281107//235620,4978142183290000320492136142405979085829//282744,1459881140954415563253751607947838024953//2520,31663466129700972962247259201794272834399495731//1612119600
